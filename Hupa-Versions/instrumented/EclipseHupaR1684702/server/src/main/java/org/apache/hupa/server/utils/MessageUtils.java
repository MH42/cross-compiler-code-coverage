/****************************************************************
 * Licensed to the Apache Software Foundation (ASF) under one   *
 * or more contributor license agreements.  See the NOTICE file *
 * distributed with this work for additional information        *
 * regarding copyright ownership.  The ASF licenses this file   *
 * to you under the Apache License, Version 2.0 (the            *
 * "License"); you may not use this file except in compliance   *
 * with the License.  You may obtain a copy of the License at   *
 *                                                              *
 *   http://www.apache.org/licenses/LICENSE-2.0                 *
 *                                                              *
 * Unless required by applicable law or agreed to in writing,   *
 * software distributed under the License is distributed on an  *
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY       *
 * KIND, either express or implied.  See the License for the    *
 * specific language governing permissions and limitations      *
 * under the License.                                           *
 ****************************************************************/

package org.apache.hupa.server.utils;


import tc3.desktop.InstrumentationLoggerProvider;
import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.UnsupportedEncodingException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import javax.activation.DataHandler;
import javax.activation.DataSource;
import javax.mail.Address;
import javax.mail.BodyPart;
import javax.mail.Message;
import javax.mail.MessagingException;
import javax.mail.Multipart;
import javax.mail.Part;
import javax.mail.internet.AddressException;
import javax.mail.internet.InternetAddress;
import javax.mail.internet.MimeBodyPart;
import javax.mail.internet.MimeMessage;
import javax.mail.internet.MimeUtility;

import org.apache.commons.fileupload.FileItem;
import org.apache.commons.logging.Log;
import org.apache.hupa.shared.data.MessageAttachmentImpl;
import org.apache.hupa.shared.domain.MessageAttachment;



/**
 * Utility methods in server side
 */
public class MessageUtils {

    /**
     * Get a Address array for a set of address passed as arguments
     *
     * @param addresses
     * @return Address array
     * @throws AddressException
     */
    public static Address[] getRecipients(String... addresses) throws AddressException {
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb37fa7c5550x20x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb37fa7c5550x4_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb37fa7c5550x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb37fa7c5550x30x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb37fa7c5550x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb37fa7c5550x3_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb37fa7c5550x0");
		InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb37fa7c555");
		InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb37fa7c5550x40x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb37fa7c5550x40x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb37fa7c5550x40x00x0");
		return getRecipients(Arrays.asList(addresses));
    }

    /**
     * Get a Address array for the given ArrayList
     *
     * @param recipients
     * @return addressArray
     * @throws AddressException
     */
    public static Address[] getRecipients(List<String> recipients) throws AddressException {
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x30x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x3_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x4_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x30x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x20x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x30x0");
		InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f");
		InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x00x0");
		if (recipients == null) {
            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x00x1");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x00x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x00x10x00x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x00x10x00x00x0");
			return new InternetAddress[]{};
        }
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x10x10x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x10x10x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x10x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x10x10x0");
		Address[] array = new Address[recipients.size()];
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x20x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x20x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x20x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x20x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x20x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x20x1");
		for (int i = 0; i < recipients.size(); i++) {
            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x20x3");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x20x30x00x00x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x20x30x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x20x30x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x20x30x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x20x30x00x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x20x30x00x00x00x1");
			array[i] = new InternetAddress(encodeEmail(recipients.get(i)));
        }
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb31749f11f0x40x3");
		return array;
    }

    /**
     * Extract the attachments present in a mime message
     *
     * @param logger
     * @param content
     * @return A list of body parts of the attachments
     * @throws MessagingException
     * @throws IOException
     */
    static public List<BodyPart> extractMessageAttachments(Log logger, Object content) throws MessagingException, IOException {
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x5_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x40x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x4_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x20x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x20x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x30x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x3");
		InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b");
		InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x00x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x00x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x00x10x00x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x00x10x00x00x0");
		ArrayList<BodyPart> ret = new ArrayList<BodyPart>();
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x1");
		if (content instanceof Multipart) {
            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x1");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x00x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x00x1");
			Multipart part = (Multipart) content;
            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x10x0");
			for (int i = 0; i < part.getCount(); i++) {
                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x3");
				InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x00x0");
				BodyPart bodyPart = part.getBodyPart(i);
                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x10x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x1");
				String fileName = bodyPart.getFileName();
                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x20x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x20x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x20x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x20x1");
				String[] contentId = bodyPart.getHeader("Content-ID");
                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x3_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x30x0");
				if (bodyPart.isMimeType("multipart/*")) {
                    InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x30x1");
					InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x30x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x30x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x30x10x00x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x30x10x00x00x0");
					ret.addAll(extractMessageAttachments(logger, bodyPart.getContent()));
                } else {
                    InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x30x2");
					InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x30x20x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x30x20x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x30x20x00x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x30x20x00x00x0");
					if (contentId != null || fileName != null) {
                        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x30x20x00x1");
						InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x30x20x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x10x10x30x30x20x00x10x00x0");
						ret.add(bodyPart);
                    }
                }
            }
        } else {
            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x2");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x20x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x20x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x20x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x20x00x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x10x20x00x00x00x00x0");
			logger.error("Unknown content: " + content.getClass().getName());
        }
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a555312b0x50x2");
		return ret;
    }

    static public List<BodyPart> extractInlineImages(Log logger, Object content) throws MessagingException, IOException {
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x20x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x4_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x3_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x30x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x40x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x20x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x5_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x2");
		InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x50x00x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x50x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x50x00x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x50x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x50x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x50x00x10x00x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x50x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x50x00x10x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x50x00x0");
		ArrayList<BodyPart> ret = new ArrayList<BodyPart>();
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x50x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x50x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x50x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x50x10x00x0");
		for (BodyPart attach : extractMessageAttachments(logger, content)) {
            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x50x10x2");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x50x10x20x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x50x10x20x00x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x50x10x20x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x50x10x20x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x50x10x20x00x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x50x10x20x00x00x00x0");
			if (attach.getHeader("Content-ID") != null && attach.getContentType().startsWith("image/")) {
				InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x50x10x20x00x1");
				InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x50x10x20x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x50x10x20x00x10x00x0");
				ret.add(attach);
			}
        }
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3e9923e4f0x50x2");
		return ret;
    }

    /**
     * Handle the parts of the given message. The method will call itself
     * recursively to handle all nested parts
     *
     * @param message the MimeMessage
     * @param content the current processing Content
     * @param sbPlain the StringBuffer to fill with text
     * @param attachmentList ArrayList with attachments
     * @throws UnsupportedEncodingException
     * @throws MessagingException
     * @throws IOException
     */
    public static boolean handleParts(Message message, Object content, StringBuffer sbPlain,
            ArrayList<MessageAttachment> attachmentList) throws UnsupportedEncodingException, MessagingException,
            IOException {
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f5");
				InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x7");
				InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x0");
		boolean isHTML = false;
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x0");
		if (content instanceof String) {
            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x1");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x10x00x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x10x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x10x0");
			if (message.getContentType().toLowerCase().startsWith("text/html")) {
                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x10x00x1");
				InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x10x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x10x00x10x00x0");
				isHTML = true;
            } else {
                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x10x00x2");
				InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x10x00x20x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x10x00x20x0");
				isHTML = false;
            }
            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x10x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x10x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x10x10x00x00x0");
			sbPlain.append((String) content);

        } else if (content instanceof Multipart) {

            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x1");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x2");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x00x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x0");
			Multipart mp = (Multipart) content;
            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x10x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x10x10x0");
			String multipartContentType = mp.getContentType().toLowerCase();

            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x20x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x20x0");
			String text = null;

            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x3_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x0");
			if (multipartContentType.startsWith("multipart/alternative")) {
                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x1");
				InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x10x00x00x0");
				isHTML = handleMultiPartAlternative(mp, sbPlain);
            } else {
                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x2");
				InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x2");
				InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x0");
				for (int i = 0; i < mp.getCount(); i++) {
                    InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x3");
					InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x0");
					Part part = mp.getBodyPart(i);

                    InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x10x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x10x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x10x1");
					String contentType = part.getContentType().toLowerCase();

                    InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x20x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x20x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x20x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x20x0");
					Boolean bodyRead = sbPlain.length() > 0;

                    InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x3_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x0");
					if (!bodyRead && contentType.startsWith("text/plain")) {
                        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x1");
						InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x10x00x0");
						isHTML = false;
                        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x10x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x10x10x00x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x10x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x10x10x00x00x0");
						text = (String) part.getContent();
                    } else if (!bodyRead && contentType.startsWith("text/html")) {
                        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x1");
						InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x2");
						InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x2");
						InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x10x0");
						isHTML = true;
                        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x10x10x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x10x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x10x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x10x10x00x00x1");
						text = (String) part.getContent();
                    } else if (!bodyRead && contentType.startsWith("message/rfc822")) {
                        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x1");
						InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x2");
						InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x2");
						InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x2");
						InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x10x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x10x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x10x00x10x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x10x00x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x10x00x10x00x1");
						// Extract the message and pass it
                        MimeMessage msg = (MimeMessage) part.getDataHandler().getContent();
                        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x10x10x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x10x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x10x10x0");
						isHTML = handleParts(msg, msg.getContent(), sbPlain, attachmentList);
                    } else {
                        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x2");
						InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x2");
						InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x2");
						InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x2");
						InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x00x0");
						if (part.getFileName() != null) {
                            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x1");
							InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x10x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x10x0");
							// Inline images are not added to the attachment
                            // list
                            // TODO: improve the in-line images detection
                            if (part.getHeader("Content-ID") == null) {
                                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x10x00x1");
								InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x10x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x10x00x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x10x00x10x00x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x10x00x10x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x10x00x10x00x1");
								MessageAttachment attachment = new MessageAttachmentImpl();
                                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x10x00x10x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x10x00x10x10x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x10x00x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x10x00x10x10x0");
								attachment.setName(MimeUtility.decodeText(part.getFileName()));
                                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x10x00x10x20x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x10x00x10x20x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x10x00x10x2");
								attachment.setContentType(part.getContentType());
                                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x10x00x10x3_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x10x00x10x30x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x10x00x10x30x00x0");
								attachment.setSize(part.getSize());
                                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x10x00x10x4_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x10x00x10x40x0");
								attachmentList.add(attachment);
                            }
                        } else {
                            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x2");
							InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x2");
							InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x2");
							InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x2");
							InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x20x00x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x20x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x20x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x00x30x30x20x20x20x00x20x0");
							isHTML = handleParts(message, part.getContent(), sbPlain, attachmentList);
                        }
                    }

                }
                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x1");
				if (text != null) {
					InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x10x1");
					InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x10x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x10x20x10x30x20x10x10x0");
					sbPlain.append(text);
				}
            }

        }
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb391d744f50x70x2");
		return isHTML;
    }

    private static boolean handleMultiPartAlternative(Multipart mp, StringBuffer sbPlain) throws MessagingException, IOException {
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f5_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x4_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x40x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x30x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x5_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x3");
		InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x0");
		String text = null;
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x1");
		boolean isHTML = false;
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x00x0");
		for (int i = 0; i < mp.getCount(); i++) {
            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x3");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x00x10x0");
			Part part = mp.getBodyPart(i);

            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x10x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x10x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x10x0");
			String contentType = part.getContentType().toLowerCase();

            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x20x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x20x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x20x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x2");
			// we prefer html
            if (text == null && contentType.startsWith("text/plain")) {
                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x20x1");
				InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x20x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x20x10x00x0");
				isHTML = false;
                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x20x10x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x20x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x20x10x10x00x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x20x10x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x20x10x10x00x00x0");
				text = (String) part.getContent();
            } else if (contentType.startsWith("text/html")) {
                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x20x20x1");
				InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x20x2");
				InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x20x20x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x20x20x10x0");
				isHTML = true;
                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x20x20x10x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x20x20x10x10x00x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x20x20x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x20x20x10x10x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x20x30x20x20x10x10x0");
				text = (String) part.getContent();
            }
        }
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x3_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x30x0");
		sbPlain.append(text);
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3bd8c51f50x50x4");
		return isHTML;
    }

    /**
     * Loop over MuliPart and write the content to the Outputstream if a
     * attachment with the given name was found.
     *
     * @param logger
     *            The logger to use
     * @param content
     *            Content which should checked for attachments
     * @param attachmentName
     *            The attachmentname or the unique id for the searched attachment
     * @throws MessagingException
     * @throws IOException
     */
    public static Part handleMultiPart(Log logger, Object content, String attachmentName)
            throws MessagingException, IOException {
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x6");
				InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f");
				InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x00x0");
		if (content instanceof Multipart) {
            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x1");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x00x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x00x0");
			Multipart part = (Multipart) content;
            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x00x0");
			for (int i = 0; i < part.getCount(); i++) {
                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x3");
				InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x00x1");
				Part bodyPart = part.getBodyPart(i);
                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x10x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x1");
				String fileName = bodyPart.getFileName();
                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x20x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x20x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x20x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x20x10x0");
				String[] contentId = bodyPart.getHeader("Content-ID");
                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x3_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x0");
				if (bodyPart.isMimeType("multipart/*")) {
                    InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x1");
					InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x10x00x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x10x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x10x00x10x0");
					Part p = handleMultiPart(logger, bodyPart.getContent(), attachmentName);
                    InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x10x10x0");
					if (p != null) {
						InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x10x10x1");
						InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x10x10x10x0");
						return p;
					}
                } else {
                    InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x2");
					InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x0");
					if (contentId != null) {
                        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x00x1");
						InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x00x10x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x00x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x00x10x0");
						for (String id: contentId) {
                            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x00x10x00x1");
							InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x00x10x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x00x10x00x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x00x10x00x10x00x00x0");
							id = id.replaceAll("^.*<(.+)>.*$", "$1");
                            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x00x10x00x10x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x00x10x00x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x00x10x00x10x10x00x0");
							System.out.println(attachmentName + " " + id);
                            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x00x10x00x10x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x00x10x00x10x20x0");
							if (attachmentName.equals(id)) {
								InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x00x10x00x10x20x1");
								InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x00x10x00x10x20x10x0");
								return bodyPart;
							}
                        }
                    }
                    InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x10x0");
					if (fileName != null) {
                        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x10x1");
						InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x10x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x10x10x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x10x10x00x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x10x10x00x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x10x10x0");
						if (cleanName(attachmentName).equalsIgnoreCase(cleanName(MimeUtility.decodeText(fileName)))) {
							InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x10x10x00x1");
							InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x10x10x30x30x20x10x10x00x10x0");
							return bodyPart;
						}
                    }
                }
            }
        } else {
            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x2");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x20x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x20x00x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x20x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x20x00x00x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x00x20x0");
			logger.error("Unknown content: " + content.getClass().getName());
        }
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f040fb1f0x60x1");
		return null;
    }

    private static String cleanName(String s) {
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb32131001b0x4_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb32131001b0x30x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb32131001b_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb32131001b0x3_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb32131001b0x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb32131001b0x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb32131001b0x1");
		InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb32131001b0x40x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb32131001b0x40x0");
		return s.replaceAll("[^\\w .+-]", "");
    }

    /**
     * Convert a FileItem to a BodyPart
     *
     * @param item
     * @return message body part
     * @throws MessagingException
     */
    public static BodyPart fileitemToBodypart(FileItem item) throws MessagingException {
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d00x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d00x30x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d00x4_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d00x3");
		InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d0");
		InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d00x40x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d00x40x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d00x40x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d00x40x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d00x40x00x10x00x0");
		MimeBodyPart messageBodyPart = new MimeBodyPart();
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d00x40x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d00x40x10x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d00x40x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d00x40x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d00x40x10x10x0");
		DataSource source = new FileItemDataStore(item);
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d00x40x20x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d00x40x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d00x40x20x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d00x40x20x00x00x0");
		messageBodyPart.setDataHandler(new DataHandler(source));
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d00x40x30x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d00x40x3_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d00x40x30x00x0");
		messageBodyPart.setFileName(source.getName());
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3f51dc6d00x40x4");
		return messageBodyPart;
    }

    /**
     * DataStore which wrap a FileItem
     *
     */
    public static class FileItemDataStore implements DataSource {

        private final FileItem item;

        public FileItemDataStore(FileItem item) {
            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d243a7d97670x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d243a7d97670x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d243a7d9767_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d243a7d97670x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d243a7d97670x3");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24cf7ff7bd0x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24cf7ff7bd0x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24cf7ff7bd0x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24cf7ff7bd_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24cf7ff7bd0x1");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24cf7ff7bd0x20x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24cf7ff7bd0x20x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x0");
			this.item = item;
        }

        /*
         * (non-Javadoc)
         * @see javax.activation.DataSource#getContentType()
         */
        @Override
		public String getContentType() {
            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d2467af0bd7");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d2467af0bd70x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d2467af0bd70x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d2467af0bd70x0");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d2467af0bd70x20x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d2467af0bd70x20x0");
			return item.getContentType();
        }

        /*
         * (non-Javadoc)
         * @see javax.activation.DataSource#getInputStream()
         */
        @Override
		public InputStream getInputStream() throws IOException {
            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d243b7e7948");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d243b7e79480x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d243b7e79480x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d243b7e79480x0");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d243b7e79480x20x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d243b7e79480x20x0");
			return item.getInputStream();
        }

        /*
         * (non-Javadoc)
         * @see javax.activation.DataSource#getName()
         */
        @Override
		public String getName() {
            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24fa98c1fd0x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24fa98c1fd0x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24fa98c1fd0x0");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24fa98c1fd");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24fa98c1fd0x20x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24fa98c1fd0x20x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24fa98c1fd0x20x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24fa98c1fd0x20x0");
			String fullName = item.getName();

            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24fa98c1fd0x20x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24fa98c1fd0x20x10x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24fa98c1fd0x20x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24fa98c1fd0x20x10x1");
			// Strip path from file
            int index = fullName.lastIndexOf(File.separator);
            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24fa98c1fd0x20x20x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24fa98c1fd0x20x20x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24fa98c1fd0x20x2");
			if (index == -1) {
                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24fa98c1fd0x20x20x1");
				InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24fa98c1fd0x20x20x10x0");
				return fullName;
            } else {
                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24fa98c1fd0x20x20x2");
				InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24fa98c1fd0x20x20x20x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24fa98c1fd0x20x20x20x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24fa98c1fd0x20x20x20x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24fa98c1fd0x20x20x20x00x00x1");
				return fullName.substring(index +1 ,fullName.length());
            }
        }

        /*
         * (non-Javadoc)
         * @see javax.activation.DataSource#getOutputStream()
         */
        @Override
		public OutputStream getOutputStream() throws IOException {
            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24f757f02c");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24f757f02c0x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24f757f02c0x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24f757f02c0x1");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb38aca4d24f757f02c0x20x0");
			return null;
        }

    }
    /**
     * Decode iso-xxxx strings present in subjects and emails like:
     *
     * =?ISO-8859-1?Q?No=20hay=20ma=F1ana?= <hello@hupa.org>
     */
    public static String decodeText(String s) {
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d");
		InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x3_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x4_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x30x0");
		InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x40x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x40x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x40x00x0");
		String ret = s;
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x40x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x40x10x0");
		try {
            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x40x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x40x10x00x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x40x10x00x00x0");
			ret = MimeUtility.decodeText(s);
        } catch (UnsupportedEncodingException e) {
            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x40x10x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x40x10x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x40x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x40x10x10x1");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x40x10x10x10x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x40x10x10x10x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x40x10x10x10x0");
			System.out.println(e.getMessage());
        }
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x40x20x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x40x20x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x40x2");
		ret =  ret
          // Remove quotes around names in email addresses
          .replaceFirst("^[<\"' ]+([^\"<>]*)[>\"' ]+<", "$1 <");
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb39c47835d0x40x3");
		return ret;
    }

    /**
     * Encode non ascii characters present in emails like:
     *
     * =?ISO-8859-1?Q?No=20hay=20ma=F1ana?= <hello@hupa.org>
     */
    public static String encodeEmail(String s) {
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb34c9873510x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb34c9873510x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb34c9873510x4_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb34c9873510x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb34c9873510x30x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb34c9873510x3");
		InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb34c987351");
		InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb34c9873510x40x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb34c9873510x40x0");
		if (s == null) {
            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb34c9873510x40x00x1");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb34c9873510x40x00x10x0");
			return s;
        }
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb34c9873510x40x10x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb34c9873510x40x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb34c9873510x40x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb34c9873510x40x10x0");
		Pattern p = Pattern.compile("^\\s*(.*?)\\s*(<[^>]+>)\\s*");
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb34c9873510x40x20x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb34c9873510x40x20x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb34c9873510x40x20x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb34c9873510x40x2");
		Matcher m = p.matcher(s);
        if(m.matches())InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb34c9873510x40x30x00x1");
		if(!(m.matches()))InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb34c9873510x40x30x00x2");
		InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb34c9873510x40x30x0");
		return m.matches() ? encodeTexts(m.group(1)) + " " + m.group(2) : s;
    }

    /**
     * Encode non ascii characters present in email headers
     */
    public static String encodeTexts(String s) {
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a64b5f5f0x2_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a64b5f5f0x4_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a64b5f5f0x30x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a64b5f5f0x3_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a64b5f5f0x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a64b5f5f0x1");
		InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a64b5f5f");
		InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a64b5f5f0x40x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a64b5f5f0x40x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a64b5f5f0x40x00x1");
		String ret = s;
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a64b5f5f0x40x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a64b5f5f0x40x1");
		if (s != null) {
            InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a64b5f5f0x40x10x1");
			InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a64b5f5f0x40x10x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a64b5f5f0x40x10x10x00x0");
			try {
                InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a64b5f5f0x40x10x10x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a64b5f5f0x40x10x10x00x00x00x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a64b5f5f0x40x10x10x00x00x00x00x0");
				ret = MimeUtility.encodeText(s, "ISO-8859-1", null);
            } catch (UnsupportedEncodingException e) {
				InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a64b5f5f0x40x10x10x00x10x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a64b5f5f0x40x10x10x00x10x0_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a64b5f5f0x40x10x10x00x1_____org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a64b5f5f0x40x10x10x00x10x00x0");
            }
        }
        InstrumentationLoggerProvider.get().instrument("org_apache_hupa_server_utils_MessageUtils_java0x071771cb3a64b5f5f0x40x2");
		return ret;
    }
}